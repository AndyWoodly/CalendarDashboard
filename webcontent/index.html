<!DOCTYPE html>
<html>
<!--
  Copyright © Andreas Hölzl
  @author twitter.com/andywoodly
-->
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>

    <link rel="stylesheet" href="styles/main.css"/>

    <script type="text/javascript"
            src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="javascript/utils.js"></script>
    <script src="javascript/date-utils.js"></script>
    <script src="javascript/CalDash.js"></script>

    <script type="text/javascript">

        // https://www.googleapis.com/calendar/v3/calendars/a0i2n11sc0e74d813ishbpiiso%40group.calendar.google.com/events?key=AIzaSyBxpeKeOwcenFKoYcjA4wMeVCEPdpN7GRo

        var eventManager = new EventManager();

        var getCalendarUrl = function () {
            var baseUrl = 'https://www.googleapis.com/calendar/v3/calendars/';
            var calId = 'a0i2n11sc0e74d813ishbpiiso%40group.calendar.google.com';
            var apiKey = 'AIzaSyBxpeKeOwcenFKoYcjA4wMeVCEPdpN7GRo';
            var timezone = 'Europe/Paris';

            //return baseUrl+calId+"/events?key="+apiKey;
            return "data.json";
        };

        var updateNextEvent = function(event) {
            var ne = document.getElementById('next_event');
            var header = document.getElementById('event_header');

            var type = document.getElementById('event_type');
            type.innerHTML = event.getType();
            var person = document.getElementById('event_person');
            person.innerHTML = event.getPerson();
            var title = document.getElementById('event_title');
            title.innerHTML = event.getTitle();
            var location = document.getElementById('event_location');
            location.innerHTML = event.getLocation();

            var start = document.getElementById('event_start');
            start.innerHTML = event.getStartDate();
            var timer = document.getElementById('event_timer');
            timer.innerHTML = "TODO timer";

            var description = document.getElementById('event_abstract');
            description.innerHTML = event.getDescription();

            // apply MathJax styling
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]); // TODO render only abstract
        };

        var updateUpcomingEvents = function(eventManager) {
            var detail_pane = document.getElementById('detail_pane');
            Utils.removeChildren(detail_pane);

            var dates = eventManager.getDates();

            if (dates.length > 0) {
                Utils.each(dates, function (date) {
                    var events = eventManager.getEventsForDate(date);

                    if (events.length > 0) {
                        var dateInstance = Utils.clone('DateTemplate');
                        dateInstance.style.visibility = 'visible';
                        detail_pane.appendChild(dateInstance);

                        var dateHeader = Utils.xpath("./div[contains(@class, 'dateHeader')]", dateInstance);
                        dateHeader.innerHTML = CalDash.utils.formatDate(date);

                        Utils.each(events, function (event) {
                            var eventInstance = Utils.clone('EventTemplate');
                            eventInstance.style.visibility = 'visible';

                            var eventTime = Utils.xpath("./div[contains(@class, 'eventTime')]", eventInstance);
                            eventTime.innerHTML = CalDash.utils.formatTime(event);
                            var eventTitle = Utils.xpath("./div[contains(@class, 'eventTitle')]", eventInstance);
                            eventTitle.innerHTML = event.getTitle();
                            var eventPerson = Utils.xpath("./div[contains(@class, 'eventPerson')]", eventInstance);
                            eventPerson.innerHTML = event.getPerson();
                            var eventLocation = Utils.xpath("./div[contains(@class, 'eventLocation')]", eventInstance);
                            eventLocation.innerHTML = event.getLocation();

                            dateInstance.appendChild(eventInstance);
                        });
                    }
                });
            }
        };

        var loadCalendar = function () {

            var failureHandler = function (url, status) {
                alert('Failed to load url ' + url + ', reason: ' + status);
//                var loading_img = document.getElementById('loading_img');
//                loading_img.style.visibility = 'hidden';
//                var loading_text = document.getElementById('loading_text');
//                loading_text.innerHtml = 'Failed to load url ' + url + ', reason: ' + status;
            };

            var successHandler = function (response) {

                var data = JSON.parse(response);
                console.log(data);

//                var now = new Date();
                var now = new Date(Date.parse("2012-05-03T10:00:00+02:00"));

                var events = GoogleConverter.convert(data.items);
                eventManager.setEvents(events);
                eventManager.update(now);

                // update ui
                updateNextEvent(eventManager.getNextEvent());
                updateUpcomingEvents(eventManager);
            };

            Utils.getFile(getCalendarUrl(), successHandler, failureHandler);
        };

    </script>
</head>

<body onload='loadCalendar()'>

<!--div id="shield">
    <div id='msg_frame'>
        <div id='msg_content'>
            <div id='loading_img'>
                <img src="images/loading.gif"/>
            </div>
            <div id='loading_text'>Loading calendar ...</div>
        </div>
    </div>
</div-->

<div id='main'>
    <div id='main_pane'>
        <div id='main_header'>
            Mathematisches Institut
        </div>
        <div id='next_event'>
            <div id='event_header'>
                <div id='event_type'></div>
                <div id='event_location'></div>
                <div id='event_person'></div>
                <div id='event_title'></div>
            </div>
            <div id='event_start'></div>
            <div id='event_timer'></div>
            <div id='event_abstract'></div>
        </div>
    </div>
    <div id='detail_pane'>

    </div>
</div>

<div id='DateTemplate' class='dateEvents' style="visibility:hidden">
    <div class='dateHeader'></div>
</div>

<div id='EventTemplate' class='event' style="visibility:hidden">
    <div class='eventTime'></div>
    <div class='eventPerson'></div>
    <div class='eventTitle'></div>
    <div class='eventLocation'></div>
</div>

</body>

</html>
